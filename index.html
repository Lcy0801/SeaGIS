<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海洋浪场数据可视化</title>
    <link rel="stylesheet" href="./leaflet/leaflet.css">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="reset.css">
    <script src="./leaflet/leaflet.js"></script>
    <script src="./jquery/jquery.js"></script>
    <script src="./leaflet-windy/windy.js"></script>
    <script src="./leaflet-wms/leaflet.wms.js"></script>
</head>

<body>
    <div id="map">
        <div id="select">
            <input type="date" name="wDate" id="wDate" placeholder="选择日期" required min="2011-08-05" max="2011-08-10">
            <input type="time" name="wTime" id="wTime" placeholder="选择时间">
            <button id='view'>查看</button>
        </div>
    </div>
</body>
<script>
    var map = L.map('map').setView([31, 121], 5);
    const tdt_img = L.tileLayer('http://t{s}.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=13aaaf7907b41c2e04034d430da1ce36', {
        subdomains: [0, 1, 2, 3, 4, 5, 6, 7],
        transparent: true,
        zIndex: 3,
        attribution: "<a href='https://www.tianditu.gov.cn/'>天地图</a>"
    });
    const tdt_cia = L.tileLayer('http://t{s}.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TileMatrix={z}&TileCol={x}&TileRow={y}&tk=13aaaf7907b41c2e04034d430da1ce36', {
        subdomains: [0, 1, 2, 3, 4, 5, 6, 7],
        transparent: true,
        zIndex: 3,
    });
    const tdt = L.layerGroup([tdt_img, tdt_cia]).addTo(map);
    var baseLayers = {
        "天地图": tdt,
    };
    var mapCtrl = L.control.layers(baseLayers).addTo(map);
    var rlay;
    var clay;
    var vlay;//矢量场图层
</script>
<script>
    var viewBt = $('#view')[0];
    viewBt.addEventListener('click', () => {
        var eDate = $('#wDate')[0];
        var eTime = $('#wTime')[0];
        var wdate = eDate.value.split('-');
        var wtime = eTime.value.split(':');
        var wdt = new Date(wdate[0], wdate[1] - 1, wdate[2], wtime[0], 0, 0, 0);
        var wstamp = wdt.getTime() / 1000;
        var sname = getServiceName(wstamp);
        if (sname == null) {
            alert('该时段内无观测数据，请重新选择!');
            return;
        }
        if (rlay) {
            rlay.remove();
            mapCtrl.removeLayer(rlay);
        }
        if (clay) {
            clay.remove();
            mapCtrl.removeLayer(clay);
        }
        if (vlay) {
            vlay.remove();
            mapCtrl.removeLayer(vlay);
        }
        var laynames = getLayerName(wstamp, sname);
        rlay = loadwms(sname, laynames[0], map);
        mapCtrl.addOverlay(rlay, '海浪场标量')
        clay = loadwms(sname, laynames[1], map);
        mapCtrl.addOverlay(clay, '海浪场等值线');
        vlay = loadvec(wstamp);
    })
    function getServiceName(wstamp) {
        var refstart = (new Date(2011, 7, 5, 8, 0, 0, 0)).getTime() / 1000;
        var refend = (new Date(2011, 7, 10, 7, 0, 0, 0)).getTime() / 1000;
        if (wstamp < refstart || wstamp > refend) {
            return null;
        }
        var tdelta = Math.floor((wstamp - refstart) / (24 * 3600));
        var start = refstart + tdelta * 24 * 3600;
        var end = start + 23 * 3600;
        var sname = '' + start + '_' + end;
        return sname;
    }
    function getLayerName(wstamp, sname) {
        sname = sname.split('_');
        var start = Number.parseInt(sname[0]);
        var end = Number.parseInt(sname[1]);
        var indexR = (wstamp - start) / 3600;
        var indexC = indexR + 24;
        return [indexR, indexC];
    }
    function loadwms(sname, layname, map) {
        var wmsurl = `https://localhost:6443/arcgis/services/SeaGIS/${sname}/MapServer/WMSServer`;
        var identify=true;
        if (layname>=24){
            identify=false;
        }
        var source=L.WMS.source(wmsurl,{
            "format": "image/png",
            "transparent": "true",
            "info_format": "text/html",
            "tiled": true,
            "identify":identify
        });
        var wmslay=source.getLayer(layname).addTo(map);
        return wmslay;
    }
    function windLayer(data) {
        var velocityLayer = L.velocityLayer({
            displayValues: true,
            displayOptions: {
                velocityType: 'GBR Wind',
                displayPosition: 'bottomleft',
                displayEmptyString: 'No wind data'
            },
            data: data,
            minVelocity: 0, //Velocity：速率
            maxVelocity: 10,
            velocityScale: 0.005,
            particleMultiplier: 1 / 100,//粒子的数量
            lineWidth: 2,                     //粒子的粗细
            frameRate: 15,                      //定义每秒执行的次数
        });
        return velocityLayer;
    }
    function loadvec(wstamp) {
        var jsonurl = `./jsons/${wstamp}.json`;
        $.getJSON(jsonurl).done((data) => {
            vlay = windLayer(data);
            vlay.addTo(map);
            mapCtrl.addOverlay(vlay, '海浪场矢量');
            return vlay;
        })
    }
</script>
<script>
    map.on('click', (e) => {
        var latlng = e.latlng;
        var lat = latlng.lat;
        var lng = latlng.lng;
        console.log([lat,lng]);
    })
</script>
</html>